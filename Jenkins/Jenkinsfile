pipeline {
    agent none

    triggers { githubPush() }

    environment {
        PREFIX_LINUX   = "Linux_report_${BUILD_NUMBER}_"
        PREFIX_WINDOWS = "Windows_report_${BUILD_NUMBER}_"
    }

    stages {

        stage('Skip Check') {
            when { not { changeset pattern: "jenkins_test_repo/**", comparator: "ANT" } }
            steps {
                echo "No changes â†’ skip"
                script {
                    env.SKIP = "true"
                    currentBuild.result = "ABORTED"
                }
            }
        }

        stage('Run Tests') {
            when { expression { env.SKIP != "true" } }
            parallel {

                stage('Linux') {
                    agent { label 'web_linux' }
                    steps {
                        sh "chmod +x Jenkins/ci/linux_*.sh"
                        sh "Jenkins/ci/linux_run.sh ${PREFIX_LINUX}"
                        script {
                            if (fileExists("${PREFIX_LINUX}*.html"))
                                stash name: "linux", includes: "${PREFIX_LINUX}*.html"
                        }
                    }
                }

                stage('Windows') {
                    agent { label 'web_windows' }
                    steps {
                        bat "Jenkins\\ci\\win_run.bat %PREFIX_WINDOWS%"
                        script {
                            def cnt = bat(script:"dir /b ${PREFIX_WINDOWS}*.html 2>nul | find /c /v \"\"",
                                           returnStdout:true).trim()
                            if (cnt != "0")
                                stash name: "windows", includes: "${PREFIX_WINDOWS}*.html"
                        }
                    }
                }

            }
        }
    }

    post {
        always {
            node('web_linux') {

                script {
                    if (currentBuild.result == "ABORTED") {
                        echo "Post skipped"
                        return
                    }
                }

                script {
                    try { unstash "linux" } catch(e){}
                    try { unstash "windows" } catch(e){}
                }

                archiveArtifacts "*.html"
            }
        }
    }
}
